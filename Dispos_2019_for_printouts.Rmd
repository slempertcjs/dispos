---
title: "Dispos_2019_for_printouts"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(gsubfn)
library(lubridate)
library(openxlsx)
library(data.table)
library(lubridate)
library(readxl)
library(fuzzyjoin)
library(tidyverse)
library(tools)
library(vroom)
library(beepr)
library(sandwich) # for robust standard errors
library(lmtest) # to run tests using the robust standard errors
library(broom) # to get stuff out of the objects lmtest produces
library(pscl) #package for pseudo R2 (pR2 function)
library(RColorBrewer)
library(sjPlot)
```

# Load and standardize collapsed dataset

Load collapsed dataset
```{r echo=FALSE, message=FALSE, warning=FALSE}
# load("G:/CrimJustice/Dispositions by Race and Ethnicity/DOJ Data 2019/Dispos.RData")
#load("G:/CrimJustice/Dispositions by Race and Ethnicity/DOJ Data 2019/Dispos Feb 2021.RData")
#load("G:/CrimJustice/Dispositions by Race and Ethnicity/DOJ Data 2019/Dispos Feb 17.RData") ## feb 17 version has incorrect hierarchy values, need to change max to min and re-run
load("G:/CrimJustice/Dispositions by Race and Ethnicity/DOJ Data 2019/Dispos Feb 24.RData")

df <- dispos %>%
  filter(arrest_felony_flag == 1) %>% #filter to only dispositions with a felony arrest, since there are also misdemeanor-only arrests for people who have other 2019 felony arrest dispositions
  #select(-cyc_order) %>%  #remove useless field
  rename(county = stp_ori_cnty_name,
         age = cyc_age)


rm(dispos)
```

Standardize factors
```{r echo=FALSE, message=FALSE, warning=FALSE}
#Standardize factors
df <- df %>%
 mutate(gender = as.factor(gender),
         
         # make age a number
         age = as.integer(age),
         age_first_dispo = as.integer(age_first_dispo),
        
         # add age category column
         age_cat = as.factor(case_when(
           age < 18 ~ "Under 18",
           age >= 18 & age <= 19 ~ "18-19 yrs",
           age > 19 & age <= 29 ~ "20-29 yrs",
           age > 29 & age <= 39 ~ "30-39 yrs",
           age > 39 & age <= 49 ~ "40-49 yrs",
           age > 49 & age <= 59 ~ "50-59 yrs",
           TRUE ~ "60+ yrs"
         )),
         
         
         # recode variables
         race = as.factor(case_when(
           race_code == "B" ~ "Black",
           race_code == "H" ~ "Hispanic",
           race_code == "W" ~ "White",
           race_code %in% c("A", "C", "D", "F", "G", "J", "K", "L", "P", "S", "U", "V", "Z") ~ "Asian/PI",
           race_code == "I" ~ "American Indian",
           T ~ "Other/Unknown")),
        
        # create a categorical variable for arrest offense type based only on felony arrest charges, prioritizing violent, then property, then drug
        arrest_f_offense_type = case_when(arrest_summ_f_violent_flag ==1 ~ "Violent",
                                         arrest_summ_f_property_flag == 1 ~ "Property",
                                         arrest_summ_f_drug_flag == 1 ~ "Drug",
                                         T ~ "Other"),
        
        #create combined suspended flag
        sent_suspended_flag = if_else(sent_ex_suspended_flag == 1 | sent_imp_suspended_flag ==1, 1, 0),
        
        #create a variable to track number of days since last dispo (will change to conviction when re-collapse completes)
        #think about what to do for ppl with no priors
        days_since_last_conv = as.integer(dispo_date - prior_conv_date), 
         
        #create scaled variables for hierarchy, and flip to make more intuitive so that higher values mean more severe crimes
        prior_max_conv_hier_scaled = -scale(prior_max_conv_hier),
        max_arrest_hier_scaled = -scale(max_arrest_hier),
        max_court_hier_scaled = -scale(max_court_hier),
        max_conv_hier_scaled = -scale(max_conv_hier),
        
        
        #create a dummy variable to indicate whether defendant has any priors, to use as an interaction term with days since last conviction
        prior_dummy = if_else(prior_convicted_flag_count >0, 1, 0),
        
        #create a categorical variable for prior record
        prior_record_cat = case_when(prior_sent_prison_flag_count >0  ~ "Prior prison",
                                      prior_sent_jail_flag_count >0  ~ "Prior jail with no prior prison",
                                      prior_convicted_flag_count >0 ~ "Prior conviction with no prior incarceration",
                                      T ~ "No prior convictions")
        
        )

```

# Descriptives

Numbers for Figure 1 flow chart
```{r warning=FALSE}
df %>%
  count(court_disp) %>%
  mutate(percent = n/sum(n)) #final court dispositions vs law enforcement/prosecution release dispositions

df %>%
  filter(court_disp ==1) %>%
  count(convicted_flag) %>%
  mutate(percent = n/sum(n)) #convicted out of those with a court disposition

df %>%
  filter(convicted_flag ==1) %>%
  count(sent_prison_flag) %>%
  mutate(percent = n/sum(n)) #prison sentences out of those convicted

df %>%
  filter(convicted_flag ==1) %>%
  count(sent_prison_flag, sent_jail_flag, sent_probation_flag) %>%
  mutate(percent = n/sum(n)) #jail and probation sentences out of those convicted


```

Demographics of felony defendants (court disposition)
```{r message=FALSE, warning=FALSE}
df %>%
  filter(court_disp ==1) %>%
  count(age_cat) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #age distribution by age category

df %>%
  filter(court_disp ==1) %>%
  count(gender) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #gender distribution

df %>%
  filter(court_disp ==1) %>%
  count(race) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #race distribution

aggregate(age ~ race, data = df %>% filter(court_disp ==1), FUN = mean)

df %>%
  filter(court_disp ==1) %>%
  group_by(race, age_cat) %>%
  summarise(n = n()) %>%
  group_by(race) %>%
  mutate(percent = round(n/sum(n)*100, 1)) %>%
  ungroup() %>%
  select(-n) %>%
  pivot_wider(names_from = age_cat, values_from = percent) %>%
  select(race, 'Under 18', '18-19 yrs', '20-29 yrs', '30-39 yrs', '40-49 yrs', '50-59 yrs', '60+ yrs')
 

#the citizen flag must be horribly inaccurate, only capturing a very small percentage of individuals
df %>%
  filter(court_disp ==1) %>%
  group_by(race, citizen) %>%
  summarise(n = n()) %>%
  group_by(race) %>%
  mutate(percent = round(n/sum(n)*100, 1)) %>%
  filter(citizen ==1)

```

Prior record of felony defendants (court disposition)
```{r message=FALSE, warning=FALSE}
df %>%
  filter(court_disp ==1) %>%
  count(prior_sent_prison_flag_count >0) %>%
  mutate(percent = round(n/sum(n)*100, 1)) # prior prison

df %>%
  filter(court_disp ==1) %>%
  count(prior_sent_prison_flag_count == 0 & prior_sent_jail_flag_count >0) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #prior jail with no prior prison

df %>%
  filter(court_disp ==1) %>%
  count(prior_sent_prison_flag_count == 0 & prior_sent_jail_flag_count == 0 & prior_sent_probation_flag_count >0) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #prior probation with no prior incarceration

df %>%
  filter(court_disp ==1) %>%
  count(prior_sent_prison_flag_count == 0 & prior_sent_jail_flag_count == 0 & prior_convicted_flag_count >0) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #prior conviction with no prior incarceration

df %>%
  filter(court_disp ==1) %>%
  count(prior_convicted_flag_count ==0) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #no prior convictions

df %>%
  filter(court_disp ==1) %>%
  count(prior_conviction_felony_flag_count >0) %>%
  mutate(percent = round(n/sum(n)*100, 1)) # has prior felony convictions

df %>%
  filter(court_disp ==1) %>%
  count(prior_conviction_felony_flag_count == 0 & prior_conviction_misd_flag_count >0) %>%
  mutate(percent = round(n/sum(n)*100, 1)) # has prior misdemeanors with no prior felonies

df %>%
  filter(court_disp ==1) %>%
  count(prior_conviction_felony_flag_count) %>%
  mutate(percent = round(n/sum(n)*100, 1)) # number of prior felony convictions

df %>%
  filter(court_disp ==1) %>%
  count(prior_conviction_misd_flag_count) %>%
  mutate(percent = round(n/sum(n)*100, 1)) # number of prior misdo convictions

mean(df$prior_conviction_felony_flag_count) #mean prior felonies
mean(df$prior_conviction_misd_flag_count) #mean prior misdos



#### prior sentences

df %>%
  filter(court_disp == 1) %>%
  mutate(prior_record_cat = case_when(prior_sent_prison_flag_count >0  ~ "Prior prison",
                                      prior_sent_jail_flag_count >0 & days_prior_jail >=365 ~ "Prior jail, 1 year or more",
                                      prior_sent_jail_flag_count >0  ~ "Prior jail, less than 1 year",
                                      prior_convicted_flag_count >0 ~ "Prior conviction with no prior incarceration",
                                      T ~ "No prior convictions")) %>%
  count(prior_record_cat) %>%
  mutate(percent = round(n/sum(n)*100, 1))


# mean days prior prison, for those who have had prior prison
df %>%
  filter(prior_sent_prison_flag_count >0) %>%
  summarise(mean(days_prior_prison, na.rm = T)) #mean prior prison time is nearly 8 years, ouch.
  # count(is.na(days_prior_prison)) %>%
  # mutate(percent = round(n/sum(n)*100, 1))

#mean days prior jail, for those who have had prior jail
df %>%
  filter(prior_sent_jail_flag_count >0) %>%
  summarise(mean(days_prior_jail, na.rm = T)) # mean prior jail time is a little less than 2 years.
  # count(is.na(days_prior_jail)) %>%
  # mutate(percent = round(n/sum(n)*100, 1))


```

Arrest offense type for felony defendants (court dispo)
```{r message=FALSE, warning=FALSE}

df %>%
  filter(court_disp ==1) %>%
  count(arrest_f_offense_type) %>%
  mutate(percent = round(n/sum(n)*100, 1)) #arrest offense type for felony arrest offenses only



```

Descriptive info on sentences
```{r message=FALSE, warning=FALSE}
df %>%
  filter(sent_prison_flag ==1) %>%
  summarise(mean(prison_length_days, na.rm = T)) #mean prison sentence term is 2039 days (5.6 years)

df %>%
  filter(sent_jail_flag == 1) %>%
  summarise(mean(jail_length_days, na.rm = T)) #mean jail sentence term is 272 days (0.75 years)

df %>%
  filter(sent_probation_flag == 1) %>%
  #count(probation_length_days)
  summarise(mean(probation_length_days, na.rm = T)) #mean probation sentence term is 1242 days (3.4 years). this might be thrown off by suspended sentences that lack probation length (many of these are zeros), and some wonky extremely large term lengths (there is one over 100,000 days = 273 years.... seems excessive)


```

Descriptive info on priors by race and age category
```{r message=FALSE, warning=FALSE}

#priors by race
df %>%
  group_by(race) %>%
  summarise(n = n(), mean_age = mean(age), mean_prior_fs = mean(prior_conviction_felony_flag_count), mean_prior_ms = mean(prior_conviction_misd_flag_count))

df %>%
  group_by(age_cat) %>%
  summarise(n = n(), mean_prior_fs = mean(prior_conviction_felony_flag_count), mean_prior_ms = mean(prior_conviction_misd_flag_count))

df %>%
  filter(court_disp == 1) %>%
  mutate(prior_f_violent = if_else(prior_conviction_summ_f_violent_flag_count > 0, 1, 0),
         prior_m_violent = if_else(prior_conviction_summ_m_violent_flag_count > 0, 1, 0),
         prior_f_drug = if_else(prior_conviction_summ_f_drug_flag_count > 0, 1, 0),
         prior_m_drug = if_else(prior_conviction_summ_m_drug_flag_count > 0, 1, 0),
         prior_f_prop = if_else(prior_conviction_summ_f_property_flag_count > 0, 1, 0),
         prior_m_prop = if_else(prior_conviction_summ_m_property_flag_count > 0, 1, 0)) %>%
  group_by(race) %>%
  summarise(across(c(prior_f_violent, prior_m_violent, prior_f_drug, prior_m_drug, prior_f_prop, prior_m_prop), mean))
  #summarise(mean(prior_f_violent), mean(prior_m_violent), mean(prior_f_drug), mean(prior_m_drug), mean(prior_f_prop), mean(prior_m_prop))

  
df %>%
  filter(court_disp == 1) %>%
  group_by(race) %>%
  summarise(across(c(prior_conviction_summ_f_violent_flag_count, prior_conviction_summ_m_violent_flag_count, prior_conviction_summ_f_drug_flag_count, prior_conviction_summ_m_drug_flag_count, prior_conviction_summ_f_property_flag_count, prior_conviction_summ_m_property_flag_count, prior_conviction_summ_f_other_sex_flag_count, prior_conviction_summ_m_other_sex_flag_count, prior_conviction_summ_f_other_flag_count, prior_conviction_summ_m_other_flag_count), ~mean(.x>0)))
#biggest racial differences in: prior felony violent, prior misdo drug


#prior convictions, at least one by type, by race
df %>%
  filter(prior_arrest_summ_f_drug_flag_count >0) %>%
  group_by(race) %>%
  summarise(across(matches("prior_conviction_summ"), ~mean(.x>0)))


#prior drug by race
df %>%
  filter(court_disp == 1) %>%
  mutate(prior_drug = prior_conviction_summ_f_drug_flag_count + prior_conviction_summ_m_drug_flag_count) %>%
  group_by(race) %>%
  summarise(mean(prior_drug>0))
  
#time since prior conviction by race
df %>%
  filter(court_disp == 1) %>%
  group_by(race) %>%
  summarise(mean(days_since_last_conv))

#age at first arrest by race
df %>%
  filter(court_disp == 1) %>%
  group_by(race) %>%
  summarise(quantile(age_first_dispo, probs = c(0.25)), mean(age_first_dispo), median(age_first_dispo), quantile(age_first_dispo, probs = c(0.75)))
```

Arrest offense categories and counts by race
```{r message=FALSE, warning=FALSE}
#arrest offense type by race
df %>%
  filter(court_disp == 1) %>%
  select(-contains("prior")) %>%
  group_by(race) %>%
  summarise(across(contains("arrest_summ"),  ~round(mean(.x>0)*100,1)))

#using categorical felony arrest offense type variable
df %>%
  filter(court_disp == 1) %>%
  group_by(race) %>%
  count(arrest_f_offense_type) %>%
  mutate(percent = round(n/sum(n)*100, 1)) %>%
  select(-n) %>%
  pivot_wider(names_from = arrest_f_offense_type, values_from = percent) %>%
  select(race, Violent, Drug, Property, Other)


#offense categories by race
df %>%
  group_by(race) %>%
  summarise(violentf = mean(arrest_f_offense_type == "Violent"), propf = mean(arrest_f_offense_type == "Property"), drugf = mean(arrest_f_offense_type == "Drug"), otherf = mean(arrest_f_offense_type == "Other"))

#offense categories by age category
df %>%
  group_by(age_cat) %>%
  summarise(violentf = mean(arrest_f_offense_type == "Violent"), propf = mean(arrest_f_offense_type == "Property"), drugf = mean(arrest_f_offense_type == "Drug"), otherf = mean(arrest_f_offense_type == "Other"))

#prior offense category counts by race
df %>%
  group_by(race) %>%
  summarise(prior_violentf = mean(prior_arrest_summ_f_violent_flag_count), prior_propf = mean(prior_arrest_summ_f_property_flag_count), prior_drugf = mean(prior_arrest_summ_f_drug_flag_count), prior_otherf = mean(prior_arrest_summ_f_other_flag_count))


#number of arrest charges and offense hierarchy by race
df %>%
  group_by(race) %>%
  summarise(fcharge = mean(arrested_fcharge_count), mcharge = mean(arrested_mcharge_count), arresthier = mean(max_arrest_hier))
```

Descriptives of outcomes for regressions
```{r message=FALSE, warning=FALSE}
#filing rate and overall conviction rate out of all arrests by race
df %>%
  group_by(race) %>%
  summarise(filing = round(mean(filed_flag)*100,1), convictions_all = round(mean(convicted_flag)*100, 1))

#conviction rate out of cases filed by race
df %>%
  filter(filed_flag == 1) %>%
  group_by(race) %>%
  summarise(conviction_of_filings = round(mean(convicted_flag)*100,1))

#felony conviction rate out of cases filed by race
df %>%
  filter(convicted_flag == 1) %>%
  group_by(race) %>%
  summarise(felony_conv_of_conv = round(mean(conviction_felony_flag)*100,1))


#prison sentencing rate out of convicted cases by race
df %>%
  filter(convicted_flag == 1) %>%
  group_by(race) %>%
  summarise(prison_of_convicted = round(mean(sent_prison_flag)*100,1))

#prison sentencing rate out of felony convicted cases by race
df %>%
  filter(convicted_flag == 1, conviction_felony_flag ==1) %>%
  group_by(race) %>%
  summarise(prison_of_fel_convicted = round(mean(sent_prison_flag)*100,1))


#prison sentence length out of cases sentenced to prison
df %>%
  filter(sent_prison_flag == 1) %>%
  group_by(race) %>%
  summarise(prison_length_yrs = round(mean(prison_length_days, na.rm = T)/365.25, 1), perc_length_na = round(mean(is.na(prison_length_days))*100,1))

```

Charts for Figure 6 -- outcomes by race
```{r}
#conviction rate out of cases filed by race
df %>%
  filter(filed_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(race) %>%
  summarise(conviction_of_filings = round(mean(convicted_flag)*100,1)) %>%
  ggplot(aes(fill=race, y= conviction_of_filings, x=race)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(conviction_of_filings, 0)), position=position_dodge(width=0.9), vjust=-0.25)

#felony conviction rate out of cases filed by race
df %>%
  filter(convicted_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(race) %>%
  summarise(felony_conv_of_conv = round(mean(conviction_felony_flag)*100,1)) %>%
  ggplot(aes(fill=race, y= felony_conv_of_conv, x=race)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(felony_conv_of_conv, 0)), position=position_dodge(width=0.9), vjust=-0.25)


#prison sentencing rate out of felony convicted cases by race
df %>%
  filter(conviction_felony_flag ==1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(race) %>%
  summarise(prison_of_fel_convicted = round(mean(sent_prison_flag)*100,1)) %>%
  ggplot(aes(fill=race, y= prison_of_fel_convicted, x=race)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(prison_of_fel_convicted, 0)), position=position_dodge(width=0.9), vjust=-0.25)



#prison sentence length out of cases sentenced to prison
df %>%
  filter(sent_prison_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(race) %>%
  summarise(prison_length_yrs = round(mean(prison_length_days, na.rm = T)/365.25, 1), perc_length_na = round(mean(is.na(prison_length_yrs))*100,1)) %>%
  ggplot(aes(fill=race, y= prison_length_yrs, x=race)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(prison_length_yrs, 1)), position=position_dodge(width=0.9), vjust=-0.25)


```

Charts for Figure 6 -- outcomes by criminal history
```{r}
#conviction rate out of cases filed by prior_record_cat
df %>%
  filter(filed_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(prior_record_cat) %>%
  summarise(conviction_of_filings = round(mean(convicted_flag)*100,1)) %>%
  ggplot(aes(fill=prior_record_cat, y= conviction_of_filings, x=prior_record_cat)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(conviction_of_filings, 0)), position=position_dodge(width=0.9), vjust=-0.25)

#felony conviction rate out of cases filed by prior_record_cat
df %>%
  filter(convicted_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(prior_record_cat) %>%
  summarise(felony_conv_of_conv = round(mean(conviction_felony_flag)*100,1)) %>%
  ggplot(aes(fill=prior_record_cat, y= felony_conv_of_conv, x=prior_record_cat)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(felony_conv_of_conv, 0)), position=position_dodge(width=0.9), vjust=-0.25)


#prison sentencing rate out of felony convicted cases by prior_record_cat
df %>%
  filter(conviction_felony_flag ==1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(prior_record_cat) %>%
  summarise(prison_of_fel_convicted = round(mean(sent_prison_flag)*100,1)) %>%
  ggplot(aes(fill=prior_record_cat, y= prison_of_fel_convicted, x=prior_record_cat)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(prison_of_fel_convicted, 0)), position=position_dodge(width=0.9), vjust=-0.25)



#prison sentence length out of cases sentenced to prison
df %>%
  filter(sent_prison_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(prior_record_cat) %>%
  summarise(prison_length_yrs = round(mean(prison_length_days, na.rm = T)/365.25, 1), perc_length_na = round(mean(is.na(prison_length_yrs))*100,1)) %>%
  ggplot(aes(fill=prior_record_cat, y= prison_length_yrs, x=prior_record_cat)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(prison_length_yrs, 1)), position=position_dodge(width=0.9), vjust=-0.25)


```

Charts for Figure 6 -- outcomes by felony arrest offense type
```{r}
#conviction rate out of cases filed by arrest_f_offense_type
df %>%
  filter(filed_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(arrest_f_offense_type) %>%
  summarise(conviction_of_filings = round(mean(convicted_flag)*100,1)) %>%
  ggplot(aes(fill=arrest_f_offense_type, y= conviction_of_filings, x=arrest_f_offense_type)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(conviction_of_filings, 0)), position=position_dodge(width=0.9), vjust=-0.25)

#felony conviction rate out of cases filed by arrest_f_offense_type
df %>%
  filter(convicted_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(arrest_f_offense_type) %>%
  summarise(felony_conv_of_conv = round(mean(conviction_felony_flag)*100,1)) %>%
  ggplot(aes(fill=arrest_f_offense_type, y= felony_conv_of_conv, x=arrest_f_offense_type)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(felony_conv_of_conv, 0)), position=position_dodge(width=0.9), vjust=-0.25)


#prison sentencing rate out of felony convicted cases by arrest_f_offense_type
df %>%
  filter(conviction_felony_flag ==1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(arrest_f_offense_type) %>%
  summarise(prison_of_fel_convicted = round(mean(sent_prison_flag)*100,1)) %>%
  ggplot(aes(fill=arrest_f_offense_type, y= prison_of_fel_convicted, x=arrest_f_offense_type)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(prison_of_fel_convicted, 0)), position=position_dodge(width=0.9), vjust=-0.25)



#prison sentence length out of cases sentenced to prison
df %>%
  filter(sent_prison_flag == 1,
         race %in% c("Black", "White", "Hispanic", "Asian/PI"),
         gender %in% c("M", "F")) %>%
  group_by(arrest_f_offense_type) %>%
  summarise(prison_length_yrs = round(mean(prison_length_days, na.rm = T)/365.25, 1), perc_length_na = round(mean(is.na(prison_length_yrs))*100,1)) %>%
  ggplot(aes(fill=arrest_f_offense_type, y= prison_length_yrs, x=arrest_f_offense_type)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(prison_length_yrs, 1)), position=position_dodge(width=0.9), vjust=-0.25)


```


Charts for Appendix D -- Conviction rates
```{r echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}

#Conviction rate by race
df %>%
  filter(filed_flag == 1) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  group_by(race) %>%
  summarise(mean(convicted_flag)) %>%
  rename(conviction_rate = 'mean(convicted_flag)') %>%
  mutate(conviction_rate = conviction_rate*100) %>%
  ggplot(aes(fill=race, y= conviction_rate, x=race)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(conviction_rate, 0)), position=position_dodge(width=0.9), vjust=-0.25)

#Conviction rate by arrest offense type and race
df %>%
  filter(filed_flag == 1) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  filter(arrest_f_offense_type %in% c("Drug", "Property", "Violent")) %>%
  group_by(race, arrest_f_offense_type) %>%
  summarise(mean(convicted_flag)) %>%
  rename(conviction_rate = 'mean(convicted_flag)') %>%
  mutate(conviction_rate = conviction_rate*100) %>%
  ggplot(aes(fill=race, y= conviction_rate, x=arrest_f_offense_type)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(conviction_rate, 0)), position=position_dodge(width=0.9), vjust=-0.25)


#Conviction rate by arrest offense type and race
df %>%
  filter(filed_flag == 1) %>%
  mutate(prior_record_cat = case_when(prior_sent_prison_flag_count >0  ~ "Prior prison",
                                      prior_sent_jail_flag_count >0  ~ "Prior jail, no prior prison",
                                      prior_convicted_flag_count >0 ~ "Prior conviction with no prior incarceration",
                                      T ~ "No prior convictions")) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  filter(arrest_f_offense_type %in% c("Drug", "Property", "Violent")) %>%
  group_by(race, prior_record_cat, arrest_f_offense_type) %>%
  summarise(mean(convicted_flag)) %>%
  rename(conviction_rate = 'mean(convicted_flag)') %>%
  mutate(conviction_rate = conviction_rate*100) %>%
  ggplot(aes(fill=race, y= conviction_rate, x= prior_record_cat)) + 
    facet_wrap(vars(arrest_f_offense_type)) +
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1") +
    theme(axis.text.x = element_text(angle = 90))+
    geom_text(aes(label=round(conviction_rate, 0)), position=position_dodge(width=0.9), vjust=-0.25)
```

Charts for Appendix D -- Felony conviction rates
```{r echo=FALSE, fig.height=10, fig.width=8,message=FALSE, warning=FALSE}

#Felony conviction rate by race
df %>%
  filter(convicted_flag == 1) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  group_by(race) %>%
  summarise(mean(conviction_felony_flag)) %>%
  rename(felony_conviction_rate = 'mean(conviction_felony_flag)') %>%
  mutate(felony_conviction_rate = felony_conviction_rate*100) %>%
  ggplot(aes(fill=race, y= felony_conviction_rate, x=race)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(felony_conviction_rate, 0)), position=position_dodge(width=0.9), vjust=-0.25)

#Felony conviction rate by arrest offense type and race
df %>%
  filter(convicted_flag == 1) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  filter(arrest_f_offense_type %in% c("Drug", "Property", "Violent")) %>%
  group_by(race, arrest_f_offense_type) %>%
  summarise(mean(conviction_felony_flag)) %>%
  rename(felony_conviction_rate = 'mean(conviction_felony_flag)') %>%
  mutate(felony_conviction_rate = felony_conviction_rate*100) %>%
  ggplot(aes(fill=race, y= felony_conviction_rate, x=arrest_f_offense_type)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")+
    geom_text(aes(label=round(felony_conviction_rate, 0)), position=position_dodge(width=0.9), vjust=-0.25)


#Felony conviction rate by arrest offense type and race
df %>%
  filter(convicted_flag == 1) %>%
  mutate(prior_record_cat = case_when(prior_sent_prison_flag_count >0  ~ "Prior prison",
                                      prior_sent_jail_flag_count >0  ~ "Prior jail, no prior prison",
                                      prior_convicted_flag_count >0 ~ "Prior conviction with no prior incarceration",
                                      T ~ "No prior convictions")) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  filter(arrest_f_offense_type %in% c("Drug", "Property", "Violent")) %>%
  group_by(race, prior_record_cat, arrest_f_offense_type) %>%
  summarise(mean(conviction_felony_flag)) %>%
  rename(felony_conviction_rate = 'mean(conviction_felony_flag)') %>%
  mutate(felony_conviction_rate = felony_conviction_rate*100) %>%
  ggplot(aes(fill=race, y= felony_conviction_rate, x= prior_record_cat)) + 
    facet_wrap(vars(arrest_f_offense_type)) +
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1") +
    theme(axis.text.x = element_text(angle = 90)) +
    geom_text(aes(label=round(felony_conviction_rate, 0)), position=position_dodge(width=0.9), vjust=-0.25)
```

Charts for Appendix D -- Prison sentencing rates
```{r echo=FALSE, fig.height=10, fig.width=8,message=FALSE, warning=FALSE}

#Prison sentencing rate of the felony convicted by race
df %>%
  filter(conviction_felony_flag == 1) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  group_by(race) %>%
  summarise(mean(sent_prison_flag)) %>%
  rename(prison_sent_rate = 'mean(sent_prison_flag)') %>%
  ggplot(aes(fill=race, y= prison_sent_rate, x=race)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")

#Prison sentencing rate of the felony convicted by arrest offense type and race
df %>%
  filter(conviction_felony_flag == 1) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  filter(arrest_f_offense_type %in% c("Drug", "Property", "Violent")) %>%
  group_by(race, arrest_f_offense_type) %>%
  summarise(mean(sent_prison_flag)) %>%
  rename(prison_sent_rate = 'mean(sent_prison_flag)') %>%
  ggplot(aes(fill=race, y= prison_sent_rate, x=arrest_f_offense_type)) + 
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1")


#Prison sentencing rate of the felony convicted by arrest offense type and race
df %>%
  filter(conviction_felony_flag == 1) %>%
  mutate(prior_record_cat = case_when(prior_sent_prison_flag_count >0  ~ "Prior prison",
                                      prior_sent_jail_flag_count >0  ~ "Prior jail, no prior prison",
                                      prior_convicted_flag_count >0 ~ "Prior conviction with no prior incarceration",
                                      T ~ "No prior convictions")) %>%
  filter(race %in% c("Black", "White", "Hispanic", "Asian/PI")) %>%
  filter(arrest_f_offense_type %in% c("Drug", "Property", "Violent")) %>%
  group_by(race, prior_record_cat, arrest_f_offense_type) %>%
  summarise(mean(sent_prison_flag)) %>%
  rename(prison_sent_rate = 'mean(sent_prison_flag)') %>%
  mutate(prison_sent_rate = prison_sent_rate*100) %>%
  ggplot(aes(fill=race, y= prison_sent_rate, x= prior_record_cat)) + 
    facet_wrap(vars(arrest_f_offense_type)) +
    geom_bar(position="dodge", stat="identity") +
    scale_color_brewer(palette = "Set1") +
    theme(axis.text.x = element_text(angle = 90)) +
    geom_text(aes(label=round(prison_sent_rate, 0)), position=position_dodge(width=0.9), vjust=-0.25)


```



# Regressions

Set desired base levels for regressions
```{r message=FALSE, warning=FALSE}
df$race <- relevel(df$race, ref="White")
df$gender <- relevel(df$gender, ref="M")
df$arrest_f_offense_type <- as.factor(df$arrest_f_offense_type)
df$arrest_f_offense_type <- relevel(df$arrest_f_offense_type, ref="Property")
df$county <- as.factor(df$county)
df$county <- relevel(df$county, ref ="LOS ANGELES")
```

Conviction regressions
```{r message=FALSE, warning=FALSE}


convic <- glm(convicted_flag ~  days_prior_prison + days_prior_jail + 
              prior_conviction_summ_f_violent_flag_count + prior_conviction_summ_m_violent_flag_count + 
              prior_conviction_summ_f_property_flag_count + prior_conviction_summ_m_property_flag_count + 
              prior_conviction_summ_f_drug_flag_count + prior_conviction_summ_m_drug_flag_count + 
              prior_conviction_sex_flag_count  + prior_conviction_dv_flag_count +
              on_prob + prior_max_conv_hier_scaled +
              court_summ_f_violent_flag + court_summ_m_violent_flag +
              court_summ_f_property_flag + court_summ_m_property_flag + 
              court_summ_f_drug_flag + court_summ_m_drug_flag +
              court_sex_flag + court_dv_flag + max_court_hier_scaled +
              filed_mcharge_count + filed_fcharge_count  + 
              age + gender + race + 
              county, 
            data = df %>%
                  filter(filed_flag == 1,
                         gender %in% c("M", "F"),
                         race %in% c("Black", "White", "Hispanic", "Asian/PI")), 
            family = 'poisson')

# summary(conv_county)
conv <- tidy(coeftest(convic, vcov. = sandwich)) %>%
  mutate(significance = case_when(p.value < 0.001 ~ "***",
                                  p.value < 0.01 ~ "**",
                                  p.value < 0.05 ~ "*",
                                  p.value < 0.1 ~ ".",
                                  T ~ ""),
         relative_risk = round(exp(estimate), 4))

conv

#number of observations in regression
nrow(df %>%
        filter(filed_flag == 1,
               gender %in% c("M", "F"),
               race %in% c("Black", "White", "Hispanic", "Asian/PI")))
```

Felony conviction regressions
```{r message=FALSE, warning=FALSE}
#conviction regression, kitchen sink
conv_fel <- glm(conviction_felony_flag ~  days_prior_prison + days_prior_jail + 
                prior_conviction_summ_f_violent_flag_count + prior_conviction_summ_m_violent_flag_count + 
                prior_conviction_summ_f_property_flag_count + prior_conviction_summ_m_property_flag_count + 
                prior_conviction_summ_f_drug_flag_count + prior_conviction_summ_m_drug_flag_count + 
                prior_conviction_sex_flag_count  + prior_conviction_dv_flag_count + 
                on_prob + prior_max_conv_hier_scaled + 
                court_summ_f_violent_flag + court_summ_m_violent_flag +
                court_summ_f_property_flag + court_summ_m_property_flag +
                court_summ_f_drug_flag + court_summ_m_drug_flag +
                court_sex_flag + court_dv_flag + max_court_hier_scaled +
                filed_mcharge_count + filed_fcharge_count  + 
                age + gender + race + 
                county, 
              data = df %>%
                  filter(convicted_flag == 1,
                         gender %in% c("M", "F"),
                         race %in% c("Black", "White", "Hispanic", "Asian/PI")), 
              family = 'poisson')

# summary(conv_county)
felcon <- tidy(coeftest(conv_fel, vcov. = sandwich)) %>%
  mutate(significance = case_when(p.value < 0.001 ~ "***",
                                  p.value < 0.01 ~ "**",
                                  p.value < 0.05 ~ "*",
                                  p.value < 0.1 ~ ".",
                                  T ~ ""),
         relative_risk = round(exp(estimate), 4))

felcon

#number of observations in regression
nrow( df %>%
         filter(convicted_flag == 1,
                gender %in% c("M", "F"),
                race %in% c("Black", "White", "Hispanic", "Asian/PI")))

```

Prison sentencing regressions
```{r message=FALSE, warning=FALSE}

#detailing priors by type
prison_sent <- glm(sent_prison_flag ~  days_prior_prison + days_prior_jail + 
                  prior_conviction_summ_f_violent_flag_count + prior_conviction_summ_m_violent_flag_count + 
                  prior_conviction_summ_f_property_flag_count + prior_conviction_summ_m_property_flag_count + 
                  prior_conviction_summ_f_drug_flag_count + prior_conviction_summ_m_drug_flag_count + 
                  prior_conviction_sex_flag_count + prior_conviction_dv_flag_count + 
                  on_prob + prior_max_conv_hier_scaled + 
                  days_since_last_conv:prior_dummy +
                  conviction_summ_f_violent_flag + conviction_summ_m_violent_flag +
                  conviction_summ_f_property_flag + conviction_summ_m_property_flag +
                  conviction_summ_f_drug_flag + conviction_summ_m_drug_flag + 
                  conviction_sex_flag + conviction_dv_flag + max_conv_hier_scaled +
                  convicted_fcharge_count + convicted_mcharge_count  + 
                  age + gender + race + 
                  county, 
                data = df %>%
                  filter(conviction_felony_flag == 1,
                         gender %in% c("M", "F"),
                         race %in% c("Black", "White", "Hispanic", "Asian/PI")), 
                family = 'poisson')


pris_sent <- tidy(coeftest(prison_sent, vcov. = sandwich)) %>%
  mutate(significance = case_when(p.value < 0.001 ~ "***",
                                  p.value < 0.01 ~ "**",
                                  p.value < 0.05 ~ "*",
                                  p.value < 0.1 ~ ".",
                                  T ~ ""),
         relative_risk = round(exp(estimate), 4))

pris_sent

 # likelihood ratio test to compare models with and without race
#model_comp <- tidy(lrtest(prison_norace, prison_sent))


#plot_model(prison_sent, type = "pred", terms = c("race", "gender")) 

#number of observations in regression
nrow(df %>%
        filter(conviction_felony_flag == 1,
               gender %in% c("M", "F"),
               race %in% c("Black", "White", "Hispanic", "Asian/PI")))

```

Prison sentence length regressions
```{r message=FALSE, warning=FALSE}

prison_length <- lm(prison_length_days ~  days_prior_prison + days_prior_jail +
                      prior_conviction_summ_f_violent_flag_count + prior_conviction_summ_f_property_flag_count +  
                      prior_conviction_summ_f_drug_flag_count + prior_conviction_summ_m_violent_flag_count + 
                      prior_conviction_summ_m_property_flag_count +  prior_conviction_summ_m_drug_flag_count +  
                      prior_conviction_sex_flag_count  + prior_conviction_dv_flag_count + 
                      on_prob + prior_max_conv_hier_scaled + 
                      days_since_last_conv:prior_dummy +
                      conviction_summ_f_violent_flag + conviction_summ_m_violent_flag +
                      conviction_summ_f_property_flag + conviction_summ_m_property_flag +
                      conviction_summ_f_drug_flag + conviction_summ_m_drug_flag + 
                      conviction_sex_flag  + conviction_dv_flag + max_conv_hier_scaled +
                      convicted_fcharge_count + convicted_mcharge_count + 
                      age  + gender + race + 
                      county, 
                    data =  df %>%
                      filter(sent_prison_flag == 1,
                             gender %in% c("M", "F"),
                             race %in% c("Black", "White", "Hispanic", "Asian/PI")))

summary(prison_length)

#lrtest(prison_length, prison_length_norace)
#anova(prison_length, prison_length_norace)
#what is the difference between lrtest and anova? which is appropriate to use here?


# plot_model(prison_length, type = "pred", terms = c("race"))

#number of observations in regression
nrow(df %>%
  filter(sent_prison_flag == 1, 
         gender %in% c("M", "F"),
         race %in% c("Black", "White", "Hispanic", "Asian/PI")))


summary(prison_length)$r.squared

prison_length_norace <- lm(prison_length_days ~  days_prior_prison + days_prior_jail +
                      prior_conviction_summ_f_violent_flag_count + prior_conviction_summ_f_property_flag_count +  
                      prior_conviction_summ_f_drug_flag_count + prior_conviction_summ_m_violent_flag_count + 
                      prior_conviction_summ_m_property_flag_count +  prior_conviction_summ_m_drug_flag_count +  
                      prior_conviction_sex_flag_count  + prior_conviction_dv_flag_count + 
                      on_prob + prior_max_conv_hier_scaled + 
                      days_since_last_conv:prior_dummy +
                      conviction_summ_f_violent_flag + conviction_summ_m_violent_flag +
                      conviction_summ_f_property_flag + conviction_summ_m_property_flag +
                      conviction_summ_f_drug_flag + conviction_summ_m_drug_flag + 
                      conviction_sex_flag  + conviction_dv_flag + max_conv_hier_scaled +
                      convicted_fcharge_count + convicted_mcharge_count + 
                      age  + gender + 
                      county, 
                    data =  df %>%
                      filter(sent_prison_flag == 1,
                             gender %in% c("M", "F"),
                             race %in% c("Black", "White", "Hispanic", "Asian/PI")))

tidy(lrtest(prison_length_norace, prison_length))
```

Variable tracking
```{r echo=FALSE, message=FALSE, warning=FALSE}
# names(df %>%
#   select(contains("prior")))
# 
# #relevant variables to control for criminal history
# prior_vars <- c("prior_conviction_restrain_flag_count", "prior_conviction_dv_possible_flag_count",  
#                 "prior_conviction_summ_f_violent_flag_count", "prior_conviction_summ_f_property_flag_count", 
#                 "prior_conviction_summ_f_drug_flag_count","prior_conviction_summ_f_other_sex_flag_count",
#                 "prior_conviction_summ_f_other_flag_count","prior_conviction_summ_m_violent_flag_count",
#                 "prior_conviction_summ_m_property_flag_count", "prior_conviction_summ_m_drug_flag_count",
#                 "prior_conviction_summ_m_other_sex_flag_count", "prior_conviction_summ_m_other_flag_count",
#                 "days_prior_prison", "days_prior_jail", "prior_max_conv_hier_scaled") 
# 
# 
# names(df %>%
#   select(contains("conviction")))

```



# Regression output including variable contributions (by category)


Create function to get McFadden Pseudo R2 values for groups of variables in a glm regression
```{r echo=FALSE, message=FALSE, warning=FALSE}

mcfaddenpr2 <- function(d, dv, crim_hist, current_crime, age, gender, location, race){
  
  dataf <- d
  
  categories <- c("crim_hist", "current_crime", "age", "gender", "location", "race")
  
  cats <- c(rep("crim_hist", length(crim_hist)), 
            rep("current_crime", length(current_crime)), 
            rep("age", length(age)),
            rep("gender", length(gender)),
            rep("location", length(location)),
            "race")
  
  ivs <- tibble(variable = c(crim_hist, current_crime, age, gender, location, race), cat = cats)
  

  test_df <- lapply(c(1:length(cats)), function(i){
    test <- ivs %>%
      filter(cat != categories[i]) %>%
      mutate(missing = categories[i])
    return(test)
  }) %>% bind_rows %>%
    bind_rows(ivs %>% mutate(missing = "full"))

  eqn_test <- lapply(c(1:length(unique(test_df$missing))), function(i){
    vars <- unique(test_df$missing)
    missing_var <- vars[i]
    test <- test_df %>%
      filter(missing == missing_var) %>%
      select(variable)

    str_lst <- ""
    for(i in c(1:nrow(test))){

      str_lst <- if_else(str_lst == "", paste0(test$variable[i]), paste0(str_lst, " + ", test$variable[i]))
      }

    fun_str <- paste0("glm(", dv, " ~ ", str_lst, ", data = dataf, family = 'poisson')")


    test_mod <- eval(parse(text = fun_str))
    
    test_pr2 <- as.tibble(pR2(test_mod)[4])%>%
              mutate(model = missing_var)
    
    return(test_pr2)
  }) %>%
    bind_rows() %>%
    mutate(difference = value[model == "full"] - value)
  
  
  # recreate full model to return output
  
  str_lst = ""
  for(i in c(1:nrow(ivs))){

      str_lst <- if_else(str_lst == "", paste0(ivs$variable[i]), paste0(str_lst, " + ", ivs$variable[i]))
      }

  fun_str <- paste0("glm(", dv, " ~ ", str_lst, ", data = dataf, family = 'poisson')")
  full_mod <- eval(parse(text = fun_str))
  
  # tidy output for full model
  mod_tidy <- tidy(coeftest(full_mod, vcov. = sandwich)) %>%
      mutate(significance = case_when(p.value < 0.001 ~ "***",
                                  p.value < 0.01 ~ "**",
                                  p.value < 0.05 ~ "*",
                                  p.value < 0.1 ~ ".",
                                  T ~ ""),
         relative_risk = round(exp(estimate), 4))
  
  # create a model without race to test against full model
  vars_norace <- ivs %>%
    filter(cat!= "race") %>%
    select(variable)
  
  str_lst = ""
  for(i in c(1:nrow(vars_norace))){

      str_lst <- if_else(str_lst == "", paste0(vars_norace$variable[i]), paste0(str_lst, " + ", vars_norace$variable[i]))
      }

  fun_str <- paste0("glm(", dv, " ~ ", str_lst, ", data = dataf, family = 'poisson')")
  full_mod_norace <- eval(parse(text = fun_str))
  
  model_comp <- tidy(lrtest(full_mod_norace, full_mod))
  
  #return a list with the pr2 values, the full model tidy ouput, the number of observations used in the model, and a list of the variables with their categories
  
  return(list(pr2 = eqn_test, full_model = mod_tidy, n = nrow(dataf), vars = ivs, lr_race_v_norace = model_comp))
}
```

Create function to get R2 values for groups of variables in a lm regression
```{r echo=FALSE, message=FALSE, warning=FALSE}

contribution_r2 <- function(d, dv, crim_hist, current_crime, age, gender, location, race){
  
  dataf <- d
  
  categories <- c("crim_hist", "current_crime", "age", "gender", "location", "race")
  
  cats <- c(rep("crim_hist", length(crim_hist)), 
            rep("current_crime", length(current_crime)), 
            rep("age", length(age)),
            rep("gender", length(gender)),
            rep("location", length(location)),
            "race")
  
  ivs <- tibble(variable = c(crim_hist, current_crime, age, gender, location, race), cat = cats)
  
  test_df <- lapply(c(1:length(cats)), function(i){
    test <- ivs %>%
      filter(cat != categories[i]) %>%
      mutate(missing = categories[i])
    return(test)
  }) %>% bind_rows %>%
    bind_rows(ivs %>% mutate(missing = "full"))

  eqn_test <- lapply(c(1:length(unique(test_df$missing))), function(i){
    vars <- unique(test_df$missing)
    missing_var <- vars[i]
    test <- test_df %>%
      filter(missing == missing_var) %>%
      select(variable)

    str_lst <- ""
    for(i in c(1:nrow(test))){

      str_lst <- if_else(str_lst == "", paste0(test$variable[i]), paste0(str_lst, " + ", test$variable[i]))
      }

    fun_str <- paste0("lm(", dv, " ~ ", str_lst, ", data = dataf)")


    test_mod <- eval(parse(text = fun_str))
    test_r2 <- as.tibble(summary(test_mod)$r.squared)%>%
              mutate(model = missing_var)
    return(test_r2)
  }) %>%
    bind_rows() %>%
    mutate(difference = value[model == "full"] - value)
  
  # recreate full model to return ouput
  str_lst = ""
  for(i in c(1:nrow(ivs))){

      str_lst <- if_else(str_lst == "", paste0(ivs$variable[i]), paste0(str_lst, " + ", ivs$variable[i]))
      }

  fun_str <- paste0("lm(", dv, " ~ ", str_lst, ", data = dataf)")
  full_mod <- eval(parse(text = fun_str))
  
  # tidy the full model output
  mod_tidy <- tidy(coeftest(full_mod, vcov. = sandwich)) %>%
      mutate(significance = case_when(p.value < 0.001 ~ "***",
                                  p.value < 0.01 ~ "**",
                                  p.value < 0.05 ~ "*",
                                  p.value < 0.1 ~ ".",
                                  T ~ ""))
  
  # create a model without race to test against full model
  vars_norace <- ivs %>%
    filter(cat!= "race") %>%
    select(variable)
  
  str_lst = ""
  for(i in c(1:nrow(vars_norace))){

      str_lst <- if_else(str_lst == "", paste0(vars_norace$variable[i]), paste0(str_lst, " + ", vars_norace$variable[i]))
      }

  fun_str <- paste0("lm(", dv, " ~ ", str_lst, ", data = dataf)")
  full_mod_norace <- eval(parse(text = fun_str))
  
  model_comp <- tidy(lrtest(full_mod_norace, full_mod))
  
  #return r2 contributions, full model tidy output, the number of observations, a list of variables with categories, and a liklihood ratio test comparison of the full model vs the full model without race
  return(list(r2 = eqn_test, full_model = mod_tidy, n = nrow(dataf), vars = ivs, lr_race_vs_norace = model_comp))

}

```

Regression and pseudo R2 output for conviction
```{r}

conv_pr2 <- mcfaddenpr2(d = df %>%
              filter(filed_flag == 1,
                         gender %in% c("M", "F"),
                         race %in% c("Black", "White", "Hispanic", "Asian/PI")),
            dv = "convicted_flag",
            crim_hist = c("days_prior_prison", "days_prior_jail", "prior_conviction_summ_f_violent_flag_count", 
            "prior_conviction_summ_m_violent_flag_count", 
            "prior_conviction_summ_f_property_flag_count", "prior_conviction_summ_m_property_flag_count", 
            "prior_conviction_summ_f_drug_flag_count", "prior_conviction_summ_m_drug_flag_count", 
            "prior_conviction_sex_flag_count", "prior_conviction_dv_flag_count", "prior_conviction_dui_flag_count",
            "on_prob", "prior_max_conv_hier_scaled", 
            "days_since_last_conv:prior_dummy"),
            current_crime = c("court_summ_f_violent_flag", "court_summ_m_violent_flag", "court_summ_f_property_flag", 
            "court_summ_m_property_flag", "court_summ_f_drug_flag", "court_summ_m_drug_flag", 
            "court_sex_flag", "court_dv_flag", "court_dui_flag",
            "max_court_hier_scaled", "filed_fcharge_count", "filed_mcharge_count"),
            age = c("age"), 
            gender = c("gender"),
            location = c("county"),
            race = c("race"))

conv_pr2

```



Regression and pseudo R2 output for felony conviction
```{r}

fel_pr2 <- mcfaddenpr2(d = df %>%
              filter(convicted_flag == 1,
                         gender %in% c("M", "F"),
                         race %in% c("Black", "White", "Hispanic", "Asian/PI")),
            dv = "conviction_felony_flag",
            crim_hist = c("days_prior_prison", "days_prior_jail", "prior_conviction_summ_f_violent_flag_count", 
            "prior_conviction_summ_m_violent_flag_count", 
            "prior_conviction_summ_f_property_flag_count", "prior_conviction_summ_m_property_flag_count", 
            "prior_conviction_summ_f_drug_flag_count", "prior_conviction_summ_m_drug_flag_count", 
            "prior_conviction_sex_flag_count", "prior_conviction_dv_flag_count", "prior_conviction_dui_flag_count",
            "on_prob", "prior_max_conv_hier_scaled", 
            "days_since_last_conv:prior_dummy"),
            current_crime = c("court_summ_f_violent_flag", "court_summ_m_violent_flag", "court_summ_f_property_flag", 
            "court_summ_m_property_flag", "court_summ_f_drug_flag", "court_summ_m_drug_flag", 
            "court_sex_flag", "court_dv_flag", "court_dui_flag", 
            "max_court_hier_scaled", "filed_fcharge_count", "filed_mcharge_count"),
            age = c("age"), 
            gender = c("gender"),
            location = c("county"),
            race = c("race"))

fel_pr2

```


Regression and pseudo R2 output for prison sentencing
```{r}

sent_pr2 <- mcfaddenpr2(d = df %>%
              filter(conviction_felony_flag == 1,
                         gender %in% c("M", "F"),
                         race %in% c("Black", "White", "Hispanic", "Asian/PI")),
            dv = "sent_prison_flag",
            crim_hist = c("days_prior_prison", "days_prior_jail", "prior_conviction_summ_f_violent_flag_count", 
            "prior_conviction_summ_m_violent_flag_count", 
            "prior_conviction_summ_f_property_flag_count", "prior_conviction_summ_m_property_flag_count", 
            "prior_conviction_summ_f_drug_flag_count", "prior_conviction_summ_m_drug_flag_count", 
            "prior_conviction_sex_flag_count", "prior_conviction_dv_flag_count", "prior_conviction_dui_flag_count",
            "on_prob", "prior_max_conv_hier_scaled", 
            "days_since_last_conv:prior_dummy"),
            current_crime = c("conviction_summ_f_violent_flag", "conviction_summ_m_violent_flag", "conviction_summ_f_property_flag", 
            "conviction_summ_m_property_flag", "conviction_summ_f_drug_flag", "conviction_summ_m_drug_flag", 
            "conviction_sex_flag", "conviction_dv_flag", "conviction_dui_flag",
            "max_conv_hier_scaled", "convicted_fcharge_count", "convicted_mcharge_count"),
            age = c("age"), 
            gender = c("gender"),
            location = c("county"),
            race = c("race"))

sent_pr2

```

R2 for sentence length
```{r}

length_r2 <- contribution_r2(d = df %>%
              filter(sent_prison_flag == 1,
                         gender %in% c("M", "F"),
                         race %in% c("Black", "White", "Hispanic", "Asian/PI")),
            dv = "prison_length_days",
            crim_hist = c("days_prior_prison", "days_prior_jail", "prior_conviction_summ_f_violent_flag_count", 
            "prior_conviction_summ_m_violent_flag_count", 
            "prior_conviction_summ_f_property_flag_count", "prior_conviction_summ_m_property_flag_count", 
            "prior_conviction_summ_f_drug_flag_count", "prior_conviction_summ_m_drug_flag_count", 
            "prior_conviction_sex_flag_count", "prior_conviction_dv_flag_count", "prior_conviction_dui_flag_count",
            "on_prob", "prior_max_conv_hier_scaled", 
            "days_since_last_conv:prior_dummy"),
            current_crime = c("conviction_summ_f_violent_flag", "conviction_summ_m_violent_flag", "conviction_summ_f_property_flag", 
            "conviction_summ_m_property_flag", "conviction_summ_f_drug_flag", "conviction_summ_m_drug_flag", 
            "conviction_sex_flag", "conviction_dv_flag", "conviction_dui_flag",  
            "max_conv_hier_scaled", "convicted_fcharge_count", "convicted_mcharge_count"),
            age = c("age"), 
            gender = c("gender"),
            location = c("county"),
            race = c("race"))

#names(prison_sent$model)

length_r2
```




